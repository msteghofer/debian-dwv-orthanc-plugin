cmake_minimum_required(VERSION 2.8)

project(DwvOrthancPlugin)

if (${CMAKE_COMPILER_IS_GNUCXX})
  set(CMAKE_C_FLAGS "${CMAKE_C_FLAGS} -Wall -pedantic -Werror")
  set(CMAKE_CXX_FLAGS "${CMAKE_CXX_FLAGS} -Wall -pedantic -Werror")
endif()

# Auto generated data directory
set(AUTOGENERATED_DIR "${CMAKE_CURRENT_BINARY_DIR}/AUTOGENERATED")
include_directories(${AUTOGENERATED_DIR})

# Check that the Orthanc SDK plugin header is available or download it
set(ORTHANC_PLUGIN_H "orthanc/OrthancCPlugin.h")
if (NOT EXISTS "${AUTOGENERATED_DIR}/${ORTHANC_PLUGIN_H}")
  include(CheckIncludeFileCXX)
  check_include_file_cxx(${ORTHANC_PLUGIN_H} HAVE_ORTHANC_H)
  if (NOT HAVE_ORTHANC_H)
    set(ORTHANC_SDK_URL "http://orthanc.googlecode.com/hg-history/Orthanc-0.8.6")
    file(MAKE_DIRECTORY "${AUTOGENERATED_DIR}/orthanc")
    file(DOWNLOAD "${ORTHANC_SDK_URL}/Plugins/Include/OrthancCPlugin.h"
      "${AUTOGENERATED_DIR}/orthanc/OrthancCPlugin.h" SHOW_PROGRESS)
  endif()
endif()

# create resources file
include(${CMAKE_SOURCE_DIR}/Resources/CMake/AutoGeneratedCode.cmake)
EmbedResources( DWV_EXPLORER ${CMAKE_CURRENT_SOURCE_DIR}/Explorer )

# create library
add_library(${PROJECT_NAME} SHARED Plugin.cpp ${AUTOGENERATED_SOURCES})

if (${CMAKE_SYSTEM_NAME} STREQUAL "Linux")
  # Linking with "pthread" is necessary, otherwise the software crashes
  # http://sourceware.org/bugzilla/show_bug.cgi?id=10652#c17
  target_link_libraries(${PROJECT_NAME} pthread dl)
endif()
